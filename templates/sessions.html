<!DOCTYPE html>
<html>
<head>
  <title>Training Sessions</title>
  <link rel="stylesheet" href="{{ url_for('club_static', filename='style.css') }}">
</head>
<style>
  /* Only affects the zones modal as a fallback */
  #zonesModal:not(.show) { display: none; }
  #zonesModal.inline-open { display: block; position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 9999; }
  #zonesModal.inline-open .modal-dialog { margin: 6rem auto; max-width: 900px; }
  #zonesModal .zones-table th,
  #zonesModal .zones-table td {
    text-align: center;
  }
</style>
<body>
  {% include "_header.html" %}

  <h2>Training Sessions</h2>

  <form method="GET" action="{{ url_for('sessions.sessions') }}" style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px;">

    <label for="from_date">From:</label>
    <input type="date" name="from_date" value="{{ from_date or '' }}">
  
    <label for="to_date">To:</label>
    <input type="date" name="to_date" value="{{ to_date or '' }}">
  
    {% if current_user.coach %}
      <label for="athlete_id">Athlete:</label>
      <select name="athlete_id">
        <option value="">-- All Athletes --</option>
        {% for a in athletes %}
          <option value="{{ a.Athlete_ID }}" {% if selected_athlete == a.Athlete_ID|string %}selected{% endif %}>
            {{ a.Full_Name }}
          </option>
        {% endfor %}
      </select>
    {% endif %}
  
    <label for="activity">Activity:</label>
    <select name="activity">
      <option value="">-- All Activities --</option>
      {% for act in ['Water','Erg', 'Static Bike', 'Run', 'Swim', 'Road Bike', 'Brisk Walk', 'Other'] %}
        <option value="{{ act }}" {% if selected_activity == act %}selected{% endif %}>{{ act }}</option>
      {% endfor %}
    </select>
  
    <label for="type">Type:</label>
    <select name="type">
      <option value="">-- All Types --</option>
      {% for typ in ['Test', 'Intervals', 'UT2', 'Cross-Training', 'Other'] %}
        <option value="{{ typ }}" {% if selected_type == typ %}selected{% endif %}>{{ typ }}</option>
      {% endfor %}
    </select>
  
    <button class="btn" type="submit">Filter</button>
    {% if current_user.coach %}
      <a class="btn" href="{{ url_for('sessions.add_session') }}">Add New Session</a>
    {% else %}
      <a class="btn" href="{{ url_for('sessions.add_session') }}">Log New Session</a>
    {% endif %}
  
    <button class="btn" type="submit" formaction="{{ url_for('sessions.download_sessions_csv') }}">Download CSV</button>
  </form>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Activity</th><th>Duration</th><th>Distance</th><th>Split</th><th>T2 Min</th><th>Type</th><th>Weight</th><th>Comment</th>
        {% if current_user.coach %}<th>Athlete</th><th>Actions</th>{% endif %}
      </tr>
    </thead>
    <tbody>
      {% for s in sessions %}
      <tr>
        <td>{{ s.Session_Date }}</td>
        <td>{{ s.Activity }}</td>
        <td>{{ s.Duration }}</td>
        <td>{{ s.Distance }}</td>
        <td>{{ s.Split }}</td>
        <td>{{ s.T2Minutes }}</td>
        <td>{{ s.Type }}</td>
        <td>{{ s.Weight }}</td>
        <td>{{ s.Comment }}</td>
        {% if current_user.coach %}
        <td>{{ s.Full_Name }}</td>
        <td>
          <a href="{{ url_for('sessions.edit_session', session_id=s.Session_ID) }}">Edit</a>
          <a href="#" onclick="openAssignModal({{ s.Session_ID }})">Assign</a>
          <a href="#"
            class="zones-link"
            data-zones-url="{{ url_for('sessions.session_zones', session_id=s.Session_ID, format='json') }}"
            data-session-title="{{ s.Session_Date }} — {{ s.Activity }} — {{ s.Full_Name }}">
            Zones
          </a>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div id="assignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
     background: rgba(0,0,0,0.5); z-index: 999;">
  <div style="background: white; width: 400px; margin: 100px auto; padding: 20px; border-radius: 6px;">
    <h3>Assign Session to Athletes</h3>
    <form method="POST" action="{{ url_for('sessions.assign_session') }}">
      <input type="hidden" name="session_id" id="assign-session-id">
      <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
        <label>
          <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"> Select All
        </label>
      
        <label for="genderFilter">Filter:</label>
        <select id="genderFilter" onchange="renderAthleteCheckboxes()" class="btn">
          <option value="all">All</option>
          <option value="M">Men</option>
          <option value="W">Women</option>
        </select>
      </div>
      
      <div id="athleteCheckboxes" style="max-height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
        <!-- Checkboxes will be injected here -->
      </div>
      <button class="btn" type="submit">Assign</button>
      <button class="btn" type="button" onclick="closeAssignModal()">Cancel</button>
    </form>
  </div>
</div>

<script>

  const allAthletes = {{ athletes | tojson }};
  function openAssignModal(sessionId) {
    document.getElementById('assign-session-id').value = sessionId;
    document.getElementById('assignModal').style.display = 'block';
  }

  function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
  }

  function renderAthleteCheckboxes() {
    const filter = document.getElementById('genderFilter').value;
    const container = document.getElementById('athleteCheckboxes');
    const selectAll = document.getElementById('selectAllCheckbox').checked;

    container.innerHTML = '';

    const filtered = allAthletes.filter(a => {
      if (filter === 'all') return true;
      return a.M_W && a.M_W.toUpperCase() === filter;
    });

    if (filtered.length === 0) {
      container.innerHTML = '<em>No athletes match this filter.</em>';
      return;
    }

    filtered.forEach(a => {
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = 'athlete_ids';
      checkbox.value = a.Athlete_ID;

      // Apply "Select All" state
      checkbox.checked = selectAll;

      label.appendChild(checkbox);
      label.append(` ${a.Full_Name}`);
      container.appendChild(label);
      container.appendChild(document.createElement('br'));
    });
  }
  function toggleSelectAll() {
    const checked = document.getElementById('selectAllCheckbox').checked;
    const checkboxes = document.querySelectorAll('#athleteCheckboxes input[type="checkbox"]');
    checkboxes.forEach(cb => cb.checked = checked);
  }

  function openAssignModal(sessionId, athleteId) {
    document.getElementById('assign-session-id').value = sessionId;
    document.getElementById('assignModal').style.display = 'block';
    document.getElementById('genderFilter').value = 'all';
    document.getElementById('selectAllCheckbox').checked = false;
    renderAthleteCheckboxes();
  }

  function openAssignModal(sessionId, athleteId) {
    document.getElementById('assign-session-id').value = sessionId;
    document.getElementById('assignModal').style.display = 'block';
    document.getElementById('genderFilter').value = 'all';
    renderAthleteCheckboxes();
  }

  function closeAssignModal() {
    document.getElementById('assignModal').style.display = 'none';
  }
</script>

{# --- Modal skeleton --- #}
<div class="modal fade" id="zonesModal" tabindex="-1" aria-labelledby="zonesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="zonesModalLabel">HR Zones</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="closeZonesModal()"></button>
      </div>

      <div class="modal-body">
        <div id="zones-loading" class="small text-muted">Loading…</div>
        <div id="zones-error" class="alert alert-danger d-none"></div>

        <div id="zones-empty" class="d-none">
          <em>No HR zones recorded for this session.</em>
        </div>

        <div id="zones-table-wrap" class="table-responsive d-none">
          <table class="table table-sm table-striped align-middle zones-table">
            <thead>
              <tr>
                <th>Zone</th>
                <th>Time in Zone</th>
                <th>Activity&nbsp;Factor</th>
                <th>Zone&nbsp;Factor</th>
                <th>T2 Minutes</th>
              </tr>
            </thead>
            <tbody id="zones-tbody"></tbody>
            <tfoot>
              <tr class="fw-bold">
                <td>Totals</td>
                <td id="zones-total-time">00:00</td>
                <td></td>
                <td></td>
                <td id="zones-total-t2">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeZonesModal()">Close</button>
      </div>
    </div>
  </div>
</div>

{# --- Script to fetch + render zones --- #}
<script>
(function() {
  const modalEl   = document.getElementById('zonesModal');
  const titleEl   = document.getElementById('zonesModalLabel');
  const loadingEl = document.getElementById('zones-loading');
  const errorEl   = document.getElementById('zones-error');
  const emptyEl   = document.getElementById('zones-empty');
  const tableWrap = document.getElementById('zones-table-wrap');
  const tbodyEl   = document.getElementById('zones-tbody');
  const totalTimeEl = document.getElementById('zones-total-time');
  const totalT2El   = document.getElementById('zones-total-t2');

  function hhmm(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
  }

  async function openZones(zonesUrl, sessionTitle) {   // << accept a URL, not an ID
    // Reset UI
    titleEl.textContent = `HR Zones — ${sessionTitle}`;
    loadingEl.classList.remove('d-none');
    errorEl.classList.add('d-none'); errorEl.textContent = '';
    emptyEl.classList.add('d-none');
    tableWrap.classList.add('d-none');
    tbodyEl.innerHTML = '';
    totalTimeEl.textContent = '00:00';
    totalT2El.textContent = '0';

    // Show modal
    if (window.bootstrap && bootstrap.Modal) {
      const inst = (bootstrap.Modal.getOrCreateInstance
                    ? bootstrap.Modal.getOrCreateInstance(modalEl)
                    : new bootstrap.Modal(modalEl));
      inst.show();
    } else {
      modalEl.style.removeProperty('display');   // <-- clear leftover inline 'none'
      modalEl.classList.add('inline-open');      // show via class
    }

    try {
      const resp = await fetch(zonesUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } }); // << use URL directly
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json();

      loadingEl.classList.add('d-none');

      if (!data.rows || data.rows.length === 0) {
        emptyEl.classList.remove('d-none');
        return;
      }

      let totalSeconds = 0;
      let totalT2 = 0;

      data.rows.forEach(r => {
        totalSeconds += (r.time_seconds || 0);
        totalT2 += (r.t2_minutes || 0);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.zone}</td>
          <td>${r.time_hm}</td>
          <td>${r.activity_factor ?? ''}</td>
          <td>${r.zone_factor ?? ''}</td>
          <td>${r.t2_minutes ?? ''}</td>
        `;
        tbodyEl.appendChild(tr);
      });

      totalTimeEl.textContent = hhmm(totalSeconds);
      totalT2El.textContent = String(totalT2);
      tableWrap.classList.remove('d-none');

    } catch (err) {
      loadingEl.classList.add('d-none');
      errorEl.textContent = 'Failed to load zones. Please try again.';
      errorEl.classList.remove('d-none');
      console.error('Zones load failed', err);
    }
  }

  document.addEventListener('click', function(e) {
    const link = e.target.closest('.zones-link');
    if (!link) return;
    e.preventDefault();
    const url = link.getAttribute('data-zones-url');  // built by url_for()
    const title = link.getAttribute('data-session-title') || 'HR Zones';
    openZones(url, title);                            // pass URL through
  });
})();

  function closeZonesModal() {
    const modalEl = document.getElementById('zonesModal');
    if (window.bootstrap && bootstrap.Modal) {
      const inst = (bootstrap.Modal.getInstance && bootstrap.Modal.getInstance(modalEl))
                || (bootstrap.Modal.getOrCreateInstance
                    ? bootstrap.Modal.getOrCreateInstance(modalEl)
                    : new bootstrap.Modal(modalEl));
      inst.hide();
    } else {
      modalEl.classList.remove('inline-open');   // hide via class
      modalEl.style.removeProperty('display');   // ensure no inline 'none' lingers
    }
  }

</script>

</body>
</html>

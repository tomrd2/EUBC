<!DOCTYPE html>
<html>
<head>
  <title>Line-Ups</title>
  <link rel="stylesheet" href="{{ url_for('club_static', filename='style.css') }}">
  <style>
    .athlete-columns { display: flex; gap: 20px; margin-bottom: 10px; }
    .column { flex: 1; background: #f2f9ff; border: 1px solid #ccc; padding: 5px; border-radius: 6px; }
    .column h3 { text-align: center; margin-top: 0; background-color: #0074D9; color: white; padding: 8px; border-radius: 4px; }
    .athlete-name { margin: 4px 0; padding: 4px; background: white; border: 1px solid #ddd; border-radius: 4px; }
    h2, h3 { line-height: 1.2; }

    /* seat slots */
    .seat-slot { min-height: 24px; border: 1px dashed #bbb; border-radius: 4px; margin: 3px 0; padding: 2px 6px; display:flex; align-items:center; justify-content:space-between; }
    .seat-slot.filled { border-style: solid; background: #fff; }
    .remove-seat { cursor: pointer; opacity: 0.7; margin-left: 8px; }
    .remove-seat:hover { opacity: 1; }
  </style>
</head>

<body>
  {% include "_header.html" %}

  <div class="header-row" style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
    <div style="display: flex; align-items: center; gap: 10px;">
      <a href="{{ url_for('outings.outings') }}" class="btn">‚Üê Back</a>
      <form method="GET" action="{{ url_for('lineups.lineup_view', outing_id=outing_id) }}">
        <select name="gender" onchange="this.form.submit()" class="btn">
          <option value="all" {% if gender_filter == 'all' %}selected{% endif %}>All</option>
          <option value="M" {% if gender_filter == 'M' %}selected{% endif %}>Men</option>
          <option value="W" {% if gender_filter == 'W' %}selected{% endif %}>Women</option>
        </select>
      </form>
    </div>
    <h2 style="color: #001f3f; margin: 0;">
      Line-Up for {{ outing.Outing_Date }} ‚Äì <em>{{ outing.Outing_Name }}</em>
    </h2>
    <div>
      {% if outing.Published == 1 %}
        <h3 style="margin: 0;">Published</h3>
      {% else %}
        <form method="POST" action="{{ url_for('lineups.publish_lineup', outing_id=outing.Outing_ID) }}" style="display: inline;">
          <input type="hidden" name="gender" value="{{ gender_filter }}">
          <button class="btn" type="submit">üì¢ Publish</button>
        </form>
        <button class="btn" onclick="openCloneModal()">üìã Clone</button>
      {% endif %}
    </div>
  </div>

  <div class="athlete-columns">
    <div class="column">
      <h3>Strokes</h3>
      {% for athlete in strokes %}
        <div class="athlete-name" draggable="true"
             data-athlete-id="{{ athlete.Athlete_ID }}"
             data-athlete-name="{{ athlete.Full_Name }}"
             data-mw="{{ athlete.M_W }}">
          {{ athlete.Full_Name }}
        </div>
      {% endfor %}
    </div>

    <div class="column">
      <h3>Bows</h3>
      {% for athlete in bows %}
        <div class="athlete-name" draggable="true"
             data-athlete-id="{{ athlete.Athlete_ID }}"
             data-athlete-name="{{ athlete.Full_Name }}"
             data-mw="{{ athlete.M_W }}">
          {{ athlete.Full_Name }}
        </div>
      {% endfor %}
    </div>

    <div class="column">
      <h3>Boths</h3>
      {% for athlete in boths %}
        <div class="athlete-name" draggable="true"
             data-athlete-id="{{ athlete.Athlete_ID }}"
             data-athlete-name="{{ athlete.Full_Name }}"
             data-mw="{{ athlete.M_W }}">
          {{ athlete.Full_Name }}
        </div>
      {% endfor %}
    </div>

    <div class="column">
      <h3>Neithers</h3>
      {% for athlete in neithers %}
        <div class="athlete-name" draggable="true"
             data-athlete-id="{{ athlete.Athlete_ID }}"
             data-athlete-name="{{ athlete.Full_Name }}"
             data-mw="{{ athlete.M_W }}">
          {{ athlete.Full_Name }}
        </div>
      {% endfor %}
    </div>

    <div class="column">
      <h3>Coxes</h3>
      {% for athlete in coxes %}
        <div class="athlete-name" draggable="true"
             data-athlete-id="{{ athlete.Athlete_ID }}"
             data-athlete-name="{{ athlete.Full_Name }}"
             data-mw="{{ athlete.M_W }}">
          {{ athlete.Full_Name }}
        </div>
      {% endfor %}
    </div>

    <div class="column" id="guest-column">
      <h3>Guests</h3>
      <input type="text" id="guest-input" placeholder="Enter guest name" style="width: 95%; box-sizing: border-box;">
      <div id="guest-list"></div>
    </div>
  </div>

  <div class="crew-grid">
    {% for crew in crews %}
      <div class="crew-column" data-crew-id="{{ crew.Crew_ID }}">
        <div class="crew-row">
          <input type="text" class="crew-edit" data-crew-id="{{ crew.Crew_ID }}" data-field="Hull_Name" value="{{ crew.Hull_Name or '' }}">
        </div>
        <div class="crew-row">
          <input type="text" class="crew-edit" data-crew-id="{{ crew.Crew_ID }}" data-field="Boat_Type" value="{{ crew.Boat_Type or '' }}">
        </div>
        <div class="crew-row">
          <input type="text" class="crew-edit" data-crew-id="{{ crew.Crew_ID }}" data-field="Crew_Name" value="{{ crew.Crew_Name or '' }}">
        </div>
        <div>
          <button class="delete-crew-btn" data-crew-id="{{ crew.Crew_ID }}">üóëÔ∏è Delete</button>
        </div>

        <div class="seats" data-crew-id="{{ crew.Crew_ID }}" data-boat-type="{{ crew.Boat_Type }}">
          <!-- JS will add seat slots -->
        </div>

      </div>
    {% endfor %}

    <div class="crew-column crew-add">
      <form action="{{ url_for('lineups.add_crew', outing_id=outing_id) }}" method="post">
        <div class="crew-row">
          <input type="hidden" name="gender" value="{{ gender_filter }}">
          <input list="hull-options" name="Hull_Name" placeholder="Hull Name" required>
          <datalist id="hull-options">
            {% for hull in available_hulls %}
              <option value="{{ hull.Hull_Name }}">
            {% endfor %}
          </datalist>
        </div>
        <div class="crew-row">
          <input type="text" name="Boat_Type" placeholder="e.g. 4+" maxlength="3" required>
        </div>
        <div class="crew-row">
          <input type="text" name="Crew_Name" placeholder="Crew Name">
        </div>
        <div class="crew-row">
          <button class="btn" type="submit" style="width: 100%; height: 24px; font-size: 13px; padding: 2px 6px;">Add</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Single Socket.IO include -->
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

 <script>
  const OUTING_ID = {{ outing_id }};
  const API = {
    assign: "{{ url_for('lineups.api_assign_seat') }}",
    remove: "{{ url_for('lineups.api_remove_seat') }}",
    updateCrew: "{{ url_for('lineups.api_update_crew_field') }}",
    deleteCrew: "{{ url_for('lineups.api_delete_crew') }}"
  };

  function postJSON(url, payload) {
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).then(r => r.json());
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Build seat slots for each crew
    document.querySelectorAll('.seats').forEach(container => {
      const boatType = (container.dataset.boatType || '').toString();
      const m = boatType.match(/\d+/);
      const seatCount = m ? parseInt(m[0], 10) : 0;
      const hasCox = boatType.includes('+');

      for (let i = 1; i <= seatCount; i++) container.appendChild(createSeatSlot(i, container));
      if (hasCox) container.appendChild(createSeatSlot('Cox', container, true));
    });

    // Populate assigned seats from server
    ({{ assigned_seats | tojson }}).forEach(seat => {
      const container = document.querySelector(`.seats[data-crew-id="${seat.Crew_ID}"]`);
      if (!container) return;
      const slot = Array.from(container.children).find(s => String(s.dataset.seat) === String(seat.Seat));
      if (!slot) return;
      fillSlot(slot, seat.Athlete_ID, seat.Athlete_Name);
      // dim athlete in list
      const elem = document.querySelector(`.athlete-name[data-athlete-id="${seat.Athlete_ID}"]`);
      if (elem) { elem.style.opacity = 0.4; elem.style.pointerEvents = 'none'; }
    });

    // Drag sources
    document.querySelectorAll('.athlete-name').forEach(el => {
      el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('athlete-id', el.dataset.athleteId);
        e.dataTransfer.setData('athlete-name', el.dataset.athleteName);
        e.dataTransfer.setData('athlete-mw', el.dataset.mw || '');
      });
    });

    // Delete crew
    document.querySelectorAll('.delete-crew-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const crewId = parseInt(btn.dataset.crewId, 10);
        if (!confirm('Delete this crew?')) return;
        const res = await postJSON(API.deleteCrew, { crew_id: crewId });
        if (res.ok) {
          const col = document.querySelector(`.crew-column[data-crew-id="${crewId}"]`);
          if (col) col.remove();
        } else {
          alert('Delete failed');
        }
      });
    });

    // Inline crew edits
    document.querySelectorAll('.crew-edit').forEach(input => {
      input.addEventListener('change', async () => {
        const payload = { crew_id: parseInt(input.dataset.crewId, 10), field: input.dataset.field, value: input.value };
        const res = await postJSON(API.updateCrew, payload);
        if (!res.ok) alert('Update failed');
      });
    });

    // Hull -> Boat_Type helper
    const hullData = {
      {% for hull in available_hulls %}
        "{{ hull.Hull_Name | escape }}": "{{ hull.Boat_Type | escape }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    };
    const hullInput = document.querySelector('[name="Hull_Name"]');
    const boatTypeInput = document.querySelector('[name="Boat_Type"]');
    if (hullInput && boatTypeInput) {
      hullInput.addEventListener('input', () => {
        const name = hullInput.value.trim();
        if (hullData[name]) boatTypeInput.value = 'O' + hullData[name];
      });
    }
  });

  function createSeatSlot(seat, container, isCox=false) {
    const slot = document.createElement('div');
    slot.className = 'seat-slot';
    slot.dataset.seat = seat;
    slot.textContent = isCox ? 'Cox' : '';
    slot.addEventListener('dragover', e => e.preventDefault());
    slot.addEventListener('drop', e => onDrop(e, container, slot));
    slot.addEventListener('dblclick', () => removeFromSlot(container, slot));
    return slot;
  }

  async function onDrop(e, container, slot) {
    e.preventDefault();
    const id   = e.dataTransfer.getData('athlete-id');  // '' for guests
    const name = e.dataTransfer.getData('athlete-name');
    const crewId = parseInt(container.dataset.crewId, 10);
    const seat = String(slot.dataset.seat);

    // remove existing assignment in this slot
    if (slot.dataset.athleteId) await removeFromSlot(container, slot, /*silent*/true);

    const res = await postJSON(API.assign, {
      outing_id: OUTING_ID, crew_id: crewId, seat, athlete_id: id, athlete_name: name
    });
    if (!res.ok) { alert('Save failed'); return; }

    fillSlot(slot, id, name);

    // dim source athlete (if not guest)
    const src = document.querySelector(`.athlete-name[data-athlete-id="${id}"]`);
    if (src) { src.style.opacity = 0.4; src.style.pointerEvents = 'none'; }
  }

  function fillSlot(slot, athleteId, athleteName) {
    slot.classList.add('filled');
    slot.dataset.athleteId = athleteId || '';
    slot.innerHTML = `
      <span class="seat-name">${athleteName}</span>
      <span class="remove-seat" title="Remove">‚úñ</span>
    `;
    slot.querySelector('.remove-seat').addEventListener('click', () => {
      const container = slot.closest('.seats');
      removeFromSlot(container, slot);
    });
  }

  async function removeFromSlot(container, slot, silent=false) {
    const crewId = parseInt(container.dataset.crewId, 10);
    const seat   = String(slot.dataset.seat);
    const prevId = slot.dataset.athleteId;

    const res = await postJSON(API.remove, { crew_id: crewId, seat });
    if (!res.ok && !silent) { alert('Remove failed'); return; }

    // clear UI
    slot.classList.remove('filled');
    slot.textContent = seat === 'Cox' ? 'Cox' : '';
    delete slot.dataset.athleteId;

    // re-enable athlete in list
    if (prevId) {
      const el = document.querySelector(`.athlete-name[data-athlete-id="${prevId}"]`);
      if (el) { el.style.opacity = 1; el.style.pointerEvents = 'auto'; }
    }
  }
</script>

  <div id="cloneModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999;">
    <div style="background:white; width:400px; margin:100px auto; padding:20px; border-radius:6px;">
      <h3>Clone a Previous Lineup</h3>
      <p style="color: red; font-weight: bold;">‚ö†Ô∏è This will delete all current crews and seat assignments.</p>
      <form id="cloneForm" method="POST"
            action="{{ url_for('lineups.clone_lineup', outing_id=outing.Outing_ID) }}"
            onsubmit="return confirmClone()">
        <input type="hidden" name="gender" value="{{ gender_filter }}">
        <select name="source_outing_id" required style="width:100%; margin-bottom: 10px;">
          {% for recent in recent_outings %}
            {% if recent.Outing_ID != outing.Outing_ID %}
              <option value="{{ recent.Outing_ID }}">{{ recent.Outing_Date }} ‚Äî {{ recent.Outing_Name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <button type="submit" class="btn">Clone</button>
        <button type="button" onclick="closeCloneModal()" class="btn">Cancel</button>
      </form>
    </div>
  </div>
</body>
</html>
